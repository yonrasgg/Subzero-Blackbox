#!/usr/bin/env python3
"""
scripts/seed_exploits.py

Example script to populate the database with initial exploit scripts.
This demonstrates how to add exploits that can be linked to vulnerabilities.
"""

import sys
from pathlib import Path

# Ensure the project root directory is in sys.path
BASE_DIR = Path(__file__).resolve().parent.parent
if str(BASE_DIR) not in sys.path:
    sys.path.insert(0, str(BASE_DIR))

from worker.db import SessionLocal, Exploit  # noqa: E402

def seed_exploits():
    session = SessionLocal()
    
    # Example 1: BlueBorne (CVE-2017-0781)
    blueborne_script = """
import bluetooth
import sys

def exploit(target_mac):
    print(f"[*] Target: {target_mac}")
    print("[*] Exploiting CVE-2017-0781 (BlueBorne)...")
    # ... exploit logic ...
    print("[+] Exploit sent.")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: exploit.py <mac>")
        sys.exit(1)
    exploit(sys.argv[1])
"""
    
    exploit1 = Exploit(
        name="BlueBorne-Android-HeapSpray",
        description="BlueBorne exploit for Android (CVE-2017-0781) - Heap Spray",
        target_service="bluetooth",
        cve_id="CVE-2017-0781",
        script_content=blueborne_script,
        language="python",
        required_args={"target_mac": "Target Bluetooth MAC address"}
    )

    # Example 2: BleedingTooth (CVE-2020-12351)
    bleedingtooth_script = """
# BleedingTooth PoC
# CVE-2020-12351
import os
import sys

def run_attack(mac):
    print(f"Running BleedingTooth against {mac}")
    # os.system(f"l2ping -c 1 {mac}")
    
if __name__ == "__main__":
    run_attack(sys.argv[1])
"""

    exploit2 = Exploit(
        name="BleedingTooth-L2CAP",
        description="BleedingTooth L2CAP Heap Overflow (CVE-2020-12351)",
        target_service="bluetooth",
        cve_id="CVE-2020-12351",
        script_content=bleedingtooth_script,
        language="python",
        required_args={"target_mac": "Target Bluetooth MAC address"}
    )

    # Check if they exist
    existing = session.query(Exploit).filter(Exploit.name.in_([exploit1.name, exploit2.name])).all()
    existing_names = {e.name for e in existing}

    if exploit1.name not in existing_names:
        session.add(exploit1)
        print(f"[+] Added exploit: {exploit1.name}")
    
    if exploit2.name not in existing_names:
        session.add(exploit2)
        print(f"[+] Added exploit: {exploit2.name}")

    session.commit()
    session.close()
    print("[*] Exploit seeding complete.")

if __name__ == "__main__":
    seed_exploits()
