{% extends "base.html" %}
{% block content %}
<h1 class="title has-text-white">Audits & Attacks Configuration</h1>
<h2 class="subtitle has-text-grey-light">Manage plugins and configurations</h2>

<div class="buttons is-right">
  <button class="button is-info is-small" onclick="reloadPlugins()">
    ðŸ”„ Reload Plugins
  </button>
</div>

<div class="tabs is-centered">
  <ul>
    <li><a href="/ui/dashboard">Dashboard</a></li>
    <li class="is-active"><a href="/ui/audits_config">Audits Configuration</a></li>
  </ul>
</div>

<div id="domains-container">
  <p class="has-text-grey has-text-centered">Loading plugins...</p>
</div>

<!-- Configuration Details (Dynamic) -->
<div id="plugin-details-container" class="modal">
  <div class="modal-background" onclick="closePluginDetails()"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title" id="selected-plugin-title">Plugin Details</p>
      <button class="delete" aria-label="close" onclick="closePluginDetails()"></button>
    </header>
    <section class="modal-card-body">
      <p id="selected-plugin-desc" class="mb-4"></p>
      <div class="tags">
        <span class="tag is-dark" id="plugin-version"></span>
        <span class="tag is-dark" id="plugin-author"></span>
        <span class="tag is-warning" id="plugin-profile"></span>
      </div>
    </section>
    <footer class="modal-card-foot">
      <button class="button" onclick="closePluginDetails()">Close</button>
    </footer>
  </div>
</div>

<script>
async function loadPlugins() {
  try {
    const response = await fetch('/api/plugins');
    const data = await response.json();
    const plugins = data.plugins;

    renderDomains(plugins);
  } catch (error) {
    console.error('Error loading plugins:', error);
    document.getElementById('domains-container').innerHTML = '<p class="has-text-danger has-text-centered">Error loading plugins.</p>';
  }
}

function renderDomains(plugins) {
  const container = document.getElementById('domains-container');
  container.innerHTML = '';

  // Define domains and their keywords/profiles
  const domains = {
    'WiFi': { icon: 'ðŸ“¶', color: 'is-info', keywords: ['wifi', 'wlan', '802.11'] },
    'Bluetooth': { icon: 'ðŸ¦·', color: 'is-link', keywords: ['bt', 'bluetooth', 'ble'] },
    'USB/HID': { icon: 'ðŸ”Œ', color: 'is-warning', keywords: ['usb', 'hid', 'ducky'] },
    'Web': { icon: 'ðŸŒ', color: 'is-danger', keywords: ['web', 'http', 'site'] },
    'Other': { icon: 'ðŸ”§', color: 'is-primary', keywords: [] }
  };

  // Helper to classify plugin
  function classify(name, metadata) {
    const text = (name + ' ' + (metadata.required_profile || '')).toLowerCase();
    for (const [domain, config] of Object.entries(domains)) {
      if (domain === 'Other') continue;
      if (config.keywords.some(k => text.includes(k))) return domain;
    }
    return 'Other';
  }

  // Organize plugins by Domain -> Type (Audit/Attack)
  const organized = {};
  for (const domain of Object.keys(domains)) {
    organized[domain] = { audits: [], attacks: [] };
  }

  // Process Audits
  if (plugins.audits) {
    for (const [name, info] of Object.entries(plugins.audits)) {
      const domain = classify(name, info.metadata);
      organized[domain].audits.push({name, info});
    }
  }

  // Process Attacks
  if (plugins.attacks) {
    for (const [name, info] of Object.entries(plugins.attacks)) {
      const domain = classify(name, info.metadata);
      organized[domain].attacks.push({name, info});
    }
  }

  // Render DOM
  for (const [domain, types] of Object.entries(organized)) {
    // Skip empty domains
    if (types.audits.length === 0 && types.attacks.length === 0) continue;

    const config = domains[domain];
    
    const domainBox = document.createElement('div');
    domainBox.className = 'box mb-5';
    
    domainBox.innerHTML = `
      <h2 class="title is-4 ${config.color}">
        <span class="icon-text">
          <span class="icon">${config.icon}</span>
          <span>${domain}</span>
        </span>
      </h2>
      <div class="columns">
        <div class="column">
          <h3 class="subtitle is-6 has-text-grey-light is-uppercase has-text-weight-bold">Audits</h3>
          <div class="audits-list"></div>
        </div>
        <div class="column">
          <h3 class="subtitle is-6 has-text-grey-light is-uppercase has-text-weight-bold">Attacks</h3>
          <div class="attacks-list"></div>
        </div>
      </div>
    `;

    // Render Audits
    const auditsContainer = domainBox.querySelector('.audits-list');
    if (types.audits.length > 0) {
      types.audits.forEach(item => {
        auditsContainer.appendChild(createPluginElement('audits', item));
      });
    } else {
      auditsContainer.innerHTML = '<p class="is-size-7 has-text-grey-light">No audit plugins.</p>';
    }

    // Render Attacks
    const attacksContainer = domainBox.querySelector('.attacks-list');
    if (types.attacks.length > 0) {
      types.attacks.forEach(item => {
        attacksContainer.appendChild(createPluginElement('attacks', item));
      });
    } else {
      attacksContainer.innerHTML = '<p class="is-size-7 has-text-grey-light">No attack plugins.</p>';
    }

    container.appendChild(domainBox);
  }
}

function createPluginElement(category, item) {
  const el = document.createElement('div');
  el.className = 'field box py-2 px-3 mb-2 is-shadowless has-background-white-ter';
  el.style.border = '1px solid #dbdbdb';
  el.style.display = 'flex';
  el.style.alignItems = 'center';
  el.style.justifyContent = 'space-between';
  
  const isChecked = item.info.enabled ? 'checked' : '';
  
  el.innerHTML = `
    <div style="display:flex; align-items:center; gap:10px;">
      <input type="checkbox" id="${category}-${item.name}" class="switch is-rounded is-success is-small" ${isChecked}>
      <label for="${category}-${item.name}" style="font-weight:600; cursor:pointer; font-size: 0.9rem;">${item.name}</label>
    </div>
    <button class="button is-small is-ghost px-1" onclick="showPluginDetails('${category}', '${item.name}')">
      <span class="icon is-small"><i class="fas fa-info-circle"></i></span>
      <span>Info</span>
    </button>
  `;

  // Event listener
  const checkbox = el.querySelector('input');
  checkbox.addEventListener('change', async (e) => {
    const action = e.target.checked ? 'enable' : 'disable';
    try {
      await fetch(`/api/plugins/${category}/${item.name}/${action}`, { method: 'POST' });
    } catch (err) {
      console.error(`Failed to ${action} plugin`, err);
      e.target.checked = !e.target.checked; // Revert on error
      alert(`Failed to ${action} plugin: ${err.message}`);
    }
  });
  
  // Store metadata
  el.dataset.metadata = JSON.stringify(item.info.metadata);
  return el;
}

function showPluginDetails(category, name) {
  const checkbox = document.getElementById(`${category}-${name}`);
  const metadata = JSON.parse(checkbox.closest('.field').dataset.metadata);
  
  document.getElementById('selected-plugin-title').textContent = `${metadata.name} (${category})`;
  document.getElementById('selected-plugin-desc').textContent = metadata.description || "No description available.";
  document.getElementById('plugin-version').textContent = `v${metadata.version}`;
  document.getElementById('plugin-author').textContent = `Author: ${metadata.author}`;
  document.getElementById('plugin-profile').textContent = `Profile: ${metadata.required_profile || 'None'}`;
  
  document.getElementById('plugin-details-container').classList.add('is-active');
}

function closePluginDetails() {
  document.getElementById('plugin-details-container').classList.remove('is-active');
}

async function reloadPlugins() {
  const btn = document.querySelector('button[onclick="reloadPlugins()"]');
  btn.classList.add('is-loading');
  try {
    await fetch('/api/plugins/reload', { method: 'POST' });
    await loadPlugins();
  } catch (error) {
    console.error('Error reloading plugins:', error);
    alert('Failed to reload plugins');
  } finally {
    btn.classList.remove('is-loading');
  }
}

// Load on start
loadPlugins();
</script>

<style>
  /* Custom switch styles if needed */
  .switch {
    position: relative;
    display: inline-block;
    width: 36px;
    height: 20px;
    margin-right: 8px;
  }
  input[type=checkbox].switch {
    appearance: none;
    width: 36px;
    height: 20px;
    background: #b5b5b5;
    border-radius: 20px;
    position: relative;
    cursor: pointer;
    outline: none;
    transition: background 0.2s;
  }
  input[type=checkbox].switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
  }
  input[type=checkbox].switch:checked {
    background: #48c774;
  }
  input[type=checkbox].switch:checked::after {
    transform: translateX(16px);
  }
</style>
{% endblock %}
